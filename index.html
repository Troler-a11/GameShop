<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARTEM STORE | GLOBAL CYBER MARKET 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,400&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --cyan: #00f2ff;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --dark-bg: #020617;
            --card-bg: #0f172a;
            --border-color: #1e293b;
            --success: #10b981;
            --error: #ef4444;
            --gold: #f59e0b;
        }

        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        @keyframes pulse-cyan { 0%, 100% { box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); } 50% { box-shadow: 0 0 25px rgba(0, 242, 255, 0.5); } }
        @keyframes slide-up { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotate-border { 0% { border-color: var(--border-color); } 50% { border-color: var(--cyan); } 100% { border-color: var(--border-color); } }

        @keyframes notify-ping {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(0, 242, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); }
        }

        .notify-active { animation: notify-ping 1.5s infinite; border-color: var(--cyan) !important; }
        .animate-slide-up { animation: slide-up 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-variant-numeric: tabular-nums; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #e2e8f0;
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.6;
        }

        .h-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border-color);
        }

        .premium-card {
            background: linear-gradient(165deg, #111827 0%, #020617 100%);
            border: 1px solid var(--border-color);
            border-radius: 32px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .premium-card:hover {
            transform: translateY(-12px);
            border-color: var(--cyan);
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        .cyber-input {
            background: #000000 !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 20px !important;
            padding: 18px 24px !important;
            color: #ffffff !important;
            transition: 0.3s;
            width: 100%;
            outline: none;
            font-size: 15px;
        }

        .cyber-input:focus {
            border-color: var(--cyan) !important;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        .btn-neon {
            background: var(--cyan);
            color: #000;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 22px;
            padding: 20px;
            transition: 0.4s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 8px 20px rgba(0, 242, 255, 0.3);
        }

        .btn-neon:active { transform: scale(0.94); }

        .bubble-me { background: linear-gradient(135deg, var(--cyan), var(--blue)); color: #000; border-radius: 24px 24px 4px 24px; }
        .bubble-them { background: #1e293b; color: #fff; border-radius: 24px 24px 24px 4px; }

        .unread-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 14px;
            height: 14px;
            background: #ef4444;
            border: 3px solid #020617;
            border-radius: 50%;
            z-index: 10;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none !important; }

        /* –°—Ç–∏–ª—å –¥–ª—è —Ñ–æ—Ç–æ –≤ —á–∞—Ç—ñ */
        .chat-img {
            max-width: 200px;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 5px;
        }

        /* –ù–æ–≤–∏–π —Å—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó */
        .cat-active {
            background: var(--cyan) !important;
            color: #000 !important;
            border-color: var(--cyan) !important;
        }
    </style>
</head>
<body class="pb-32">

    <div id="auth-system" class="fixed inset-0 z-[99999] bg-slate-950 flex items-center justify-center p-4 overflow-y-auto">
        <div class="w-full max-w-lg bg-slate-900 border border-slate-800 p-8 md:p-12 rounded-[3.5rem] shadow-2xl animate-slide-up my-auto">
            <div id="auth-reg-box" class="space-y-8">
                <div class="text-center">
                    <div class="inline-block px-4 py-1 rounded-full bg-cyan-500/10 text-cyan-400 text-[10px] font-black tracking-[0.4em] mb-4 uppercase">Neural Registration</div>
                    <h2 class="h-font text-3xl text-white font-black">ARTEM<span class="text-cyan-400">STORE</span></h2>
                    <p class="text-slate-500 text-xs mt-3">–°—Ç–≤–æ—Ä–∏ —Å–≤—ñ–π —Ü–∏—Ñ—Ä–æ–≤–∏–π –≤—ñ–¥–±–∏—Ç–æ–∫ —É —Å–∏—Å—Ç–µ–º—ñ</p>
                </div>
                <div class="flex flex-col items-center gap-6">
                    <input type="file" id="reg-p-file" class="hidden" accept="image/*">
                    <label for="reg-p-file" class="cursor-pointer group">
                        <div id="reg-p-preview" class="w-28 h-28 rounded-[2.5rem] border-2 border-dashed border-slate-700 flex items-center justify-center bg-black overflow-hidden group-hover:border-cyan-500 transition-all duration-500">
                            <span class="text-[9px] text-slate-600 font-black group-hover:text-cyan-400">UPLOAD PHOTO</span>
                        </div>
                    </label>
                </div>
                <div class="space-y-4">
                    <input type="text" id="reg-full-name" placeholder="–í–∞—à–µ —ñ–º'—è" class="cyber-input">
                    <input type="text" id="reg-user-nick" placeholder="Username (–∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é)" class="cyber-input">
                    <input type="email" id="reg-user-email" placeholder="Email Address" class="cyber-input">
                    <input type="password" id="reg-user-pass" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" class="cyber-input">
                </div>
                <button onclick="handleVerificationProcess()" class="w-full btn-neon">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                <div class="text-center pt-4">
                    <p class="text-slate-500 text-[11px] uppercase font-bold">–í–∂–µ –º–∞—î—à –∞–∫–∞—É–Ω—Ç?</p>
                    <button onclick="toggleAuthMode('login')" class="text-cyan-400 text-xs font-black mt-2 underline tracking-widest">–£–í–Ü–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
                </div>
            </div>
            <div id="auth-login-box" class="hidden space-y-10">
                <div class="text-center">
                    <h2 class="h-font text-3xl text-white">LOGIN<span class="text-cyan-400">CORE</span></h2>
                    <p class="text-slate-500 text-xs mt-3 uppercase">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –ø–æ—à—Ç—É —Ç–∞ –ø–∞—Ä–æ–ª—å</p>
                </div>
                <div class="space-y-5">
                    <input type="email" id="login-email" placeholder="–í–∞—à–∞ –ø–æ—à—Ç–∞" class="cyber-input">
                    <input type="password" id="login-pass" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" class="cyber-input">
                </div>
                <button onclick="processSystemLogin()" class="w-full btn-neon">–ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è</button>
                <div class="text-center pt-4">
                    <button onclick="toggleAuthMode('reg')" class="text-slate-500 text-[10px] font-black uppercase tracking-widest hover:text-white">–ù–∞–∑–∞–¥ –¥–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</button>
                </div>
            </div>
            <div id="reg-step-2" class="hidden space-y-10 text-center animate-slide-up">
                <div>
                    <h2 class="h-font text-3xl text-white italic">CONFIRM</h2>
                    <p class="text-slate-400 text-xs mt-3">–í–≤–µ–¥—ñ—Ç—å 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥ –∑ –≤–∞—à–æ—ó –ø–æ—à—Ç–∏</p>
                </div>
                <input type="text" id="v-otp" maxlength="6" class="w-full bg-black border-2 border-cyan-500 p-6 rounded-3xl text-center text-5xl font-black text-cyan-400 tracking-[0.4em] outline-none">
                <button onclick="finalizeRegistration()" class="w-full btn-neon" style="background: #fff; color: #000;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <header class="sticky top-0 z-[1000] glass-panel px-6 py-5 flex justify-between items-center border-b border-slate-800">
        <div class="flex items-center gap-4" onclick="navigate('shop')">
            <div class="relative">
                <img id="user-p-avatar" class="w-12 h-12 rounded-2xl hidden object-cover border-2 border-cyan-500">
                <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-slate-900"></div>
            </div>
            <div>
                <h1 class="h-font text-xl font-black text-white italic">ARTEM<span class="text-cyan-400">STORE</span></h1>
                <p class="text-[8px] text-slate-600 font-bold uppercase tracking-widest">Global Marketplace 2026</p>
            </div>
        </div>
        <button id="inbox-btn" onclick="openInboxSystem()" class="relative p-4 bg-slate-900/80 rounded-2xl border border-slate-800 transition-all">
            <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <div id="notify-indicator" class="hidden unread-dot"></div>
        </button>
    </header>

    <main class="max-w-6xl mx-auto p-5 md:p-8">
        <section id="page-shop" class="space-y-12 animate-slide-up">
            <div id="categories" class="flex gap-4 overflow-x-auto no-scrollbar py-2">
                <button onclick="setMarketCategory('all')" id="cat-all" class="cat-active bg-slate-900 border border-slate-800 px-8 py-4 rounded-2xl text-[10px] font-black uppercase">–í—Å–µ</button>
            </div>
            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </section>

        <section id="page-admin" class="hidden max-w-2xl mx-auto space-y-10 animate-slide-up">
            <div class="text-center">
                <h2 class="h-font text-3xl text-cyan-400 uppercase">New Listing</h2>
                <p class="text-slate-500 text-xs mt-2 font-bold tracking-widest">–í–ò–°–¢–ê–í–¢–ï –°–í–Ü–ô –¢–û–í–ê–† –ù–ê –ü–†–û–î–ê–ñ</p>
            </div>
            <div class="bg-slate-900/50 p-10 rounded-[3.5rem] border border-slate-800 space-y-8">
                <select id="p-new-game" class="cyber-input"></select>
                <input type="text" id="p-new-title" placeholder="–ù–∞–∑–≤–∞ –≤–∞—à–æ—ó –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó..." class="cyber-input">
                <input type="number" id="p-new-price" placeholder="–¶—ñ–Ω–∞ –≤ USD" class="cyber-input">
                <textarea id="p-new-desc" placeholder="–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —Ç–æ–≤–∞—Ä—É..." class="cyber-input h-40"></textarea>
                <input type="file" id="p-new-img" class="hidden" accept="image/*">
                <label for="p-new-img" class="flex flex-col items-center justify-center p-12 border-2 border-dashed border-slate-800 rounded-3xl hover:border-cyan-500 cursor-pointer">
                    <span class="text-[10px] text-slate-500 font-black">–ó–ê–í–ê–ù–¢–ê–ñ–ò–¢–ò –°–ö–†–Ü–ù–®–û–¢</span>
                </label>
                <button onclick="submitProductToFirebase()" class="w-full btn-neon">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –Ω–∞ —Ä–∏–Ω–∫—É</button>
            </div>
        </section>

        <section id="page-profile" class="hidden space-y-10 animate-slide-up">
            <div class="bg-gradient-to-br from-slate-900 to-black p-12 rounded-[4rem] border border-slate-800 text-center shadow-2xl relative overflow-hidden">
                <img id="p-view-avatar" class="w-40 h-40 rounded-[3.5rem] border-4 border-cyan-500 mx-auto object-cover mb-8 shadow-2xl">
                <h2 id="p-view-name" class="h-font text-4xl font-black text-white italic"></h2>
                <p id="p-view-nick" class="text-cyan-400 font-mono tracking-[0.4em] uppercase text-xs mt-3"></p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-12">
                    <div class="bg-black/40 p-6 rounded-[2rem] border border-slate-800"><p class="text-[9px] text-slate-600 font-black uppercase">–ü–†–û–î–ê–ù–û</p><span class="text-2xl font-black text-white">0</span></div>
                    <div class="bg-black/40 p-6 rounded-[2rem] border border-slate-800"><p class="text-[9px] text-slate-600 font-black uppercase">–ö–£–ü–õ–ï–ù–û</p><span class="text-2xl font-black text-white">0</span></div>
                    <div class="bg-black/40 p-6 rounded-[2rem] border border-slate-800">
                        <p class="text-[9px] text-slate-600 font-black uppercase">–†–ï–ô–¢–ò–ù–ì</p>
                        <span id="p-view-rating" class="text-xl font-black text-gold">–ù–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤</span>
                    </div>
                    <div class="bg-black/40 p-6 rounded-[2rem] border border-slate-800"><p class="text-[9px] text-slate-600 font-black uppercase">STATUS</p><span class="text-2xl font-black text-cyan-400">PRO</span></div>
                </div>
            </div>
            <div class="max-w-xl mx-auto space-y-4">
                <button onclick="filterMyProducts()" class="w-full flex items-center justify-between p-8 bg-slate-900/50 rounded-[2.5rem] border border-slate-800 hover:border-cyan-500 transition-all">
                    <div class="flex items-center gap-5">
                        <span class="text-2xl">üì¶</span>
                        <span class="font-black text-sm uppercase tracking-widest">–ú–æ—ó –∞–∫—Ç–∏–≤–Ω—ñ –ª–æ—Ç–∏</span>
                    </div>
                    <span id="my-lots-count" class="bg-cyan-500 text-black px-4 py-1 rounded-xl font-black">0</span>
                </button>
                <button onclick="systemSignOut()" class="w-full p-10 text-red-500 font-black text-[10px] uppercase tracking-[0.6em] opacity-40 hover:opacity-100 transition-all">Logout from Database</button>
            </div>
        </section>
    </main>

    <div id="system-inbox" class="hidden fixed inset-0 z-[9000] glass-panel flex items-center justify-center p-6">
        <div class="w-full max-w-lg bg-slate-950 rounded-[4rem] h-[80vh] flex flex-col border border-slate-800 shadow-2xl overflow-hidden">
            <div class="p-10 border-b border-slate-900 flex justify-between items-center bg-slate-900/20">
                <h2 class="h-font text-2xl text-white">INBOX</h2>
                <button onclick="closeModal('system-inbox')" class="w-12 h-12 flex items-center justify-center bg-slate-900 rounded-2xl text-slate-500">‚úï</button>
            </div>
            <div id="inbox-list" class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar"></div>
        </div>
    </div>

    <div id="product-details-modal" class="hidden fixed inset-0 z-[11000] glass-panel flex items-center justify-center p-6">
        <div class="w-full max-w-2xl bg-slate-950 rounded-[3rem] border border-slate-800 p-8 space-y-6 overflow-y-auto max-h-[90vh]">
            <h2 id="modal-p-title" class="h-font text-2xl text-white font-black"></h2>
            <img id="modal-p-img" class="w-full rounded-3xl border border-slate-800">
            <div class="p-6 bg-slate-900/50 rounded-2xl">
                <p id="modal-p-desc" class="text-slate-400 text-sm whitespace-pre-wrap"></p>
            </div>
            <button onclick="closeModal('product-details-modal')" class="w-full btn-neon">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

    <nav class="fixed bottom-0 inset-x-0 h-28 glass-panel border-t border-slate-800 flex justify-around items-center z-[5000] px-8">
        <button onclick="navigate('shop')" class="flex flex-col items-center gap-2"><svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg><span class="text-[9px] font-black uppercase tracking-widest text-cyan-400">Shop</span></button>
        <button id="nav-btn-admin" onclick="navigate('admin')" class="hidden flex flex-col items-center gap-2"><svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg><span class="text-[9px] font-black uppercase tracking-widest text-slate-600">Sell</span></button>
        <button onclick="navigate('profile')" class="flex flex-col items-center gap-2"><svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><span class="text-[9px] font-black uppercase tracking-widest text-slate-600">User</span></button>
    </nav>

    <div id="system-chat" class="hidden fixed inset-0 z-[10000] bg-black flex flex-col">
        <header class="p-8 border-b border-slate-900 glass-panel flex items-center justify-between">
            <div class="flex items-center gap-6">
                <button onclick="closeModal('system-chat')" class="text-cyan-400 text-3xl">‚Üê</button>
                <img id="chat-partner-av" class="w-14 h-14 rounded-2xl object-cover">
                <div>
                    <span id="chat-partner-nick" class="font-black text-white block"></span>
                    <span class="text-[9px] text-cyan-500 uppercase tracking-widest animate-pulse">Online</span>
                </div>
            </div>
            <button onclick="deleteCurrentChat()" class="text-red-500 text-[10px] font-black border border-red-500/20 px-3 py-1 rounded-lg">DELETE CHAT</button>
        </header>
        <div id="chat-messages-container" class="flex-1 overflow-y-auto p-8 flex flex-col gap-6 no-scrollbar"></div>
        <footer class="p-8 glass-panel flex gap-4 items-center">
            <button onclick="document.getElementById('chat-img-input').click()" class="p-5 bg-slate-900 rounded-2xl border border-slate-800">üì∑</button>
            <input type="file" id="chat-img-input" class="hidden" accept="image/*" onchange="sendChatImage(this)">
            
            <input type="text" id="chat-input-field" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." class="flex-1 cyber-input">
            <button onclick="processMessageSend()" class="p-6 bg-cyan-500 text-black rounded-2xl font-black">‚û§</button>
        </footer>
    </div>

    <script>
        // --- CONFIG ---
        const FIRE_CONFIG = { databaseURL: "https://gameshop-ff113-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(FIRE_CONFIG);
        const DB_LAYER = firebase.database();
        emailjs.init("KErbU8_xE37eaf0qi");

        const CATEGORIES_MASTER = ["Brawl Stars", "Standoff 2", "PUBG Mobile", "Roblox", "Steam", "Genshin Impact", "Free Fire", "Clash Royale"];
        const SUPER_ADMIN = "ilemberk3356@gmail.com";

        let app_state = {
            current_user: JSON.parse(localStorage.getItem('artem_user_v4')) || null,
            otp_code: null,
            temp_avatar_buffer: null,
            active_chat_partner: null,
            is_viewing_my_lots: false,
            current_filter: 'all' // –î–æ–¥–∞–Ω–æ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
        };

        // --- AUTH ---
        function toggleAuthMode(mode) {
            document.getElementById('auth-reg-box').classList.toggle('hidden', mode === 'login');
            document.getElementById('auth-login-box').classList.toggle('hidden', mode === 'reg');
        }

        async function processSystemLogin() {
            const email = document.getElementById('login-email').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const snap = await DB_LAYER.ref('users').get();
            const users = snap.val();
            let found = null;
            if(users) {
                Object.values(users).forEach(u => { if(u.email === email && u.password === pass) found = u; });
            }
            if(found) { localStorage.setItem('artem_user_v4', JSON.stringify(found)); location.reload(); }
            else alert("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó!");
        }

        async function handleVerificationProcess() {
            const name = document.getElementById('reg-full-name').value;
            const nick = document.getElementById('reg-user-nick').value.trim();
            const email = document.getElementById('reg-user-email').value.trim();
            const pass = document.getElementById('reg-user-pass').value;

            if(!name || !nick || !email || !pass) return alert("–í—Å—ñ –ø–æ–ª—è –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ!");
            
            const users_snap = await DB_LAYER.ref('users').get();
            const all_users = users_snap.val();
            if(all_users) {
                const email_exists = Object.values(all_users).some(u => u.email === email);
                if(email_exists) return alert("–¶—è –ø–æ—à—Ç–∞ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∞!");
            }

            const check_nick = await DB_LAYER.ref('users/' + nick).get();
            if(check_nick.exists()) return alert("–ù—ñ–∫–Ω–µ–π–º –∑–∞–π–Ω—è—Ç–∏–π!");

            app_state.otp_code = Math.floor(100000 + Math.random() * 900000).toString();
            emailjs.send('service_dbkrnz9', 'template_n90xvc9', { to_email: email, otp_code: app_state.otp_code })
                .then(() => {
                    document.getElementById('auth-reg-box').classList.add('hidden');
                    document.getElementById('reg-step-2').classList.remove('hidden');
                });
        }

        function finalizeRegistration() {
            if(document.getElementById('v-otp').value === app_state.otp_code) {
                const user_payload = {
                    name: document.getElementById('reg-full-name').value,
                    nick: document.getElementById('reg-user-nick').value.trim(),
                    email: document.getElementById('reg-user-email').value,
                    password: document.getElementById('reg-user-pass').value,
                    avatar: app_state.temp_avatar_buffer || "https://api.dicebear.com/7.x/bottts/svg?seed=" + Math.random(),
                    is_admin: document.getElementById('reg-user-email').value === SUPER_ADMIN,
                    rating: null,
                    created_at: Date.now()
                };
                DB_LAYER.ref('users/' + user_payload.nick).set(user_payload);
                localStorage.setItem('artem_user_v4', JSON.stringify(user_payload));
                location.reload();
            } else alert("–ö–æ–¥ –Ω–µ–≤—ñ—Ä–Ω–∏–π!");
        }

        document.getElementById('reg-p-file').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => {
                app_state.temp_avatar_buffer = reader.result;
                document.getElementById('reg-p-preview').innerHTML = `<img src="${reader.result}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // --- NAVIGATION ---
        function navigate(target) {
            app_state.is_viewing_my_lots = false;
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`page-${target}`).classList.remove('hidden');
            if(target === 'shop') initializeMarket();
        }
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            if(id === 'system-chat') {
                const chat_id = [app_state.current_user.nick, app_state.active_chat_partner.nick].sort().join('_');
                DB_LAYER.ref('chats/' + chat_id).off();
            }
        }
        function systemSignOut() { localStorage.clear(); location.reload(); }

        // --- MARKET & CATEGORIES ---
        function setMarketCategory(cat) {
            app_state.current_filter = cat;
            document.querySelectorAll('#categories button').forEach(b => b.classList.remove('cat-active'));
            const safe_id = cat.replace(/\s+/g, '-');
            document.getElementById('cat-' + safe_id).classList.add('cat-active');
            initializeMarket();
        }

        function renderProduct(id, item) {
            const is_my_item = app_state.current_user.nick === item.seller_nick;
            return `
                <div class="premium-card p-8 animate-slide-up">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-[9px] bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 px-4 py-2 rounded-xl font-black uppercase">${item.game}</span>
                        <button onclick="showProductDetails('${id}')" class="text-slate-500 text-xl font-black">‚Ä¢‚Ä¢‚Ä¢</button>
                    </div>
                    <img src="${item.img}" class="w-full h-56 object-cover rounded-[2.5rem] mb-6 shadow-2xl">
                    <h3 class="font-black text-xl text-white mb-3 truncate">${item.title}</h3>
                    <div class="flex items-center gap-3 mb-8">
                        <img src="${item.seller_avatar}" class="w-6 h-6 rounded-lg object-cover">
                        <span class="text-[10px] text-slate-500 font-bold uppercase">@${item.seller_nick}</span>
                    </div>
                    <div class="flex flex-col gap-4 pt-6 border-t border-slate-900">
                        <div class="flex justify-between items-center">
                            <span class="text-3xl font-black text-white">$${item.price}</span>
                            <div class="flex gap-2">
                                <button onclick="executeChatInitiation('${item.seller_nick}', '${item.seller_avatar}')" class="bg-slate-900 p-4 rounded-2xl text-cyan-400">Chat</button>
                                ${!is_my_item ? `<button onclick="handleBuyClick('${id}', '${item.seller_nick}')" class="btn-neon px-6 text-[10px]">–ö–£–ü–ò–¢–ò</button>` : ''}
                            </div>
                        </div>
                        ${app_state.is_viewing_my_lots ? `<button onclick="deleteLot('${id}')" class="w-full py-3 bg-red-500/10 text-red-500 rounded-xl text-[10px] font-black uppercase">–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä</button>` : ''}
                    </div>
                </div>
            `;
        }

        async function showProductDetails(id) {
            const snap = await DB_LAYER.ref('products/' + id).get();
            const p = snap.val();
            if(p) {
                document.getElementById('modal-p-title').innerText = p.title;
                document.getElementById('modal-p-img').src = p.img;
                document.getElementById('modal-p-desc').innerText = p.desc || "–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π";
                document.getElementById('product-details-modal').classList.remove('hidden');
            }
        }

        async function handleBuyClick(id, seller) {
            const p_snap = await DB_LAYER.ref('products/' + id).get();
            const product = p_snap.val();
            const s_snap = await DB_LAYER.ref('users/' + seller).get();
            const seller_data = s_snap.val();

            // 1. Email —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
            emailjs.send('service_dbkrnz9', 'template_n90xvc9', { 
                to_email: seller_data.email, 
                otp_code: `–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞: ${product.title}` 
            });

            // 2. –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —á–∞—Ç –∑ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º
            const buy_text = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —Ö–æ—á—É –∫—É–ø–∏—Ç—å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç ${product.title} (ID: ${id}) –∑–∞ $${product.price}`;
            document.getElementById('chat-input-field').value = buy_text;
            executeChatInitiation(seller, seller_data.avatar);
            alert("–ó–∞–ø–∏—Ç –Ω–∞ –ø–æ–∫—É–ø–∫—É –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–æ—à—Ç—É! –¢–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ —É –ø–æ–ª—ñ –≤–≤–æ–¥—É.");
        }

        function deleteLot(id) {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä –∑ —Ä–∏–Ω–∫—É?")) {
                DB_LAYER.ref('products/' + id).remove().then(() => initializeMarket());
            }
        }

        function filterMyProducts() {
            app_state.is_viewing_my_lots = true;
            navigate('shop');
            DB_LAYER.ref('products').once('value', (snap) => {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';
                const data = snap.val();
                if(data) {
                    Object.keys(data).forEach(id => {
                        if(data[id].seller_nick === app_state.current_user.nick) grid.innerHTML += renderProduct(id, data[id]);
                    });
                }
            });
        }

        function initializeMarket() {
            DB_LAYER.ref('products').on('value', (snap) => {
                const grid = document.getElementById('product-grid');
                if(!app_state.is_viewing_my_lots) {
                    grid.innerHTML = '';
                    const data = snap.val();
                    if(data) {
                        Object.keys(data).reverse().forEach(id => {
                            if(app_state.current_filter === 'all' || data[id].game === app_state.current_filter) {
                                grid.innerHTML += renderProduct(id, data[id]);
                            }
                        });
                    }
                }
            });
        }

        function submitProductToFirebase() {
            const file = document.getElementById('p-new-img').files[0];
            if(!file) return alert("–§–æ—Ç–æ –æ–±–æ–≤'—è–∑–∫–æ–≤–µ!");
            const reader = new FileReader();
            reader.onload = () => {
                const new_ref = DB_LAYER.ref('products').push();
                new_ref.set({
                    game: document.getElementById('p-new-game').value,
                    title: document.getElementById('p-new-title').value,
                    price: document.getElementById('p-new-price').value,
                    desc: document.getElementById('p-new-desc').value,
                    img: reader.result,
                    seller_nick: app_state.current_user.nick,
                    seller_avatar: app_state.current_user.avatar,
                    timestamp: Date.now()
                }).then(() => { alert("–û–ü–£–ë–õ–Ü–ö–û–í–ê–ù–û!"); navigate('shop'); });
            };
            reader.readAsDataURL(file);
        }

        // --- CHAT WITH IMAGES & DELETE ---
        function sendChatImage(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const chat_id = [app_state.current_user.nick, app_state.active_chat_partner.nick].sort().join('_');
                DB_LAYER.ref('chats/' + chat_id).push({
                    sender: app_state.current_user.nick,
                    img: reader.result,
                    time: Date.now()
                });
            };
            reader.readAsDataURL(file);
        }

        function executeChatInitiation(nick, avatar) {
            if(nick === app_state.current_user.nick) return;
            app_state.active_chat_partner = { nick, avatar };
            document.getElementById('chat-partner-nick').innerText = "@" + nick;
            document.getElementById('chat-partner-av').src = avatar || "https://api.dicebear.com/7.x/bottts/svg?seed=" + nick;
            document.getElementById('system-chat').classList.remove('hidden');
            const chat_id = [app_state.current_user.nick, nick].sort().join('_');
            
            DB_LAYER.ref('chats/' + chat_id).on('value', (snap) => {
                const container = document.getElementById('chat-messages-container');
                container.innerHTML = '';
                const messages = snap.val();
                if(messages) {
                    Object.values(messages).forEach(m => {
                        const is_me = m.sender === app_state.current_user.nick;
                        const content = m.img ? `<img src="${m.img}" class="chat-img" onclick="window.open('${m.img}')">` : m.text;
                        container.innerHTML += `
                            <div class="flex flex-col ${is_me ? 'items-end' : 'items-start'}">
                                <div class="p-5 ${is_me ? 'bubble-me' : 'bubble-them'} max-w-[85%] text-sm font-bold">
                                    ${content}
                                </div>
                            </div>
                        `;
                    });
                }
                container.scrollTop = container.scrollHeight;
            });
        }

        function processMessageSend() {
            const input = document.getElementById('chat-input-field');
            const text = input.value.trim();
            if(!text) return;
            const chat_id = [app_state.current_user.nick, app_state.active_chat_partner.nick].sort().join('_');
            DB_LAYER.ref('chats/' + chat_id).push({ sender: app_state.current_user.nick, text: text, time: Date.now() });
            input.value = '';
        }

        async function deleteCurrentChat() {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤–µ—Å—å —á–∞—Ç –Ω–∞–∑–∞–≤–∂–¥–∏?")) {
                const chat_id = [app_state.current_user.nick, app_state.active_chat_partner.nick].sort().join('_');
                await DB_LAYER.ref('chats/' + chat_id).remove();
                closeModal('system-chat');
                openInboxSystem(); // –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
            }
        }

        async function openInboxSystem() {
            document.getElementById('system-inbox').classList.remove('hidden');
            const list = document.getElementById('inbox-list');
            list.innerHTML = '';
            const snap = await DB_LAYER.ref('chats').once('value');
            const chats = snap.val();
            if(chats) {
                for(let id in chats) {
                    if(id.includes(app_state.current_user.nick)) {
                        const partner = id.replace(app_state.current_user.nick, '').replace('_', '');
                        list.innerHTML += `
                            <div onclick="executeChatInitiation('${partner}', '')" class="p-6 bg-slate-900 border border-slate-800 rounded-3xl text-white font-black flex justify-between items-center">
                                <span>@${partner}</span>
                                <span class="text-[8px] text-cyan-400">ACTIVE SESSION</span>
                            </div>`;
                    }
                }
            }
            document.getElementById('inbox-btn').classList.remove('notify-active');
            document.getElementById('notify-indicator').classList.add('hidden');
        }

        function listenForNotifications() {
            DB_LAYER.ref('chats').on('child_changed', (snap) => {
                if(snap.key.includes(app_state.current_user.nick)) {
                    document.getElementById('inbox-btn').classList.add('notify-active');
                    document.getElementById('notify-indicator').classList.remove('hidden');
                }
            });
        }

        // --- BOOT ---
        window.onload = () => {
            if(app_state.current_user) {
                document.getElementById('auth-system').classList.add('hidden');
                document.getElementById('user-p-avatar').src = app_state.current_user.avatar;
                document.getElementById('user-p-avatar').classList.remove('hidden');
                document.getElementById('p-view-avatar').src = app_state.current_user.avatar;
                document.getElementById('p-view-name').innerText = app_state.current_user.name;
                document.getElementById('p-view-nick').innerText = "@" + app_state.current_user.nick;
                
                const rat = app_state.current_user.rating;
                document.getElementById('p-view-rating').innerText = rat ? rat : "–ù–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤";

                if(app_state.current_user.is_admin) document.getElementById('nav-btn-admin').classList.remove('hidden');
                initializeMarket();
                listenForNotifications();
            }
            CATEGORIES_MASTER.forEach(n => {
                const safe_id = n.replace(/\s+/g, '-');
                document.getElementById('categories').innerHTML += `
                    <button id="cat-${safe_id}" onclick="setMarketCategory('${n}')" class="bg-slate-900 border border-slate-800 px-8 py-4 rounded-2xl text-[10px] font-black uppercase text-slate-500 whitespace-nowrap">${n}</button>
                `;
                document.getElementById('p-new-game').innerHTML += `<option value="${n}">${n}</option>`;
            });
        };
    </script>
</body>
</html>
